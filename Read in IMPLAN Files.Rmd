---
title: "Read In Implan Results Files"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(readr)
library(stargazer)
library(ggformula)
library(tidyverse)
library(matsindf)
library(matsbyname)
library(igraph)

data   <- file.path("Data")
pgms <- file.path("Data Management Files")
indepvars <- file.path("IMPLAN Independent Vars")
IOFiles <- file.path("IMPLAN IO Tables")
results <- file.path("FinalResults")
setup <- file.path("IMPLAN Simulation Set-up Files")

```

```{bash}
./CreateAggIOFile.sh
./CreateAggResultsFile.sh
```

## Read in the IO matrices 
```{r readfiles}
filename="AggIOall.csv"
fileNamewithPath <- file.path(data,IOFiles,filename)

IOall <- as_tibble(read_csv(fileNamewithPath)) %>% rename(s01=s1,s02=s2,s03=s3,
                                                          s04=s4,s05=s5,s06=s6,
                                                          s07=s7,s08=s8,s09=s9) %>%
                  mutate_all(~replace(., is.na(.), 0)) %>% 
                  select(-desc)   

```

## Create the IO Metrics as needed.
```{r IO metrics}

IOwide <- IOall %>% filter(sector!=0) %>%
            mutate(rownames=dplyr::recode(sector,`1`="s01",`2`="s02",`3`="s03",
                                        `4`="s04",`5`="s05",
                                        `6`="s06",`7`="s07",`8`="s08",
                                        `9`="s09",`10`="s10",`11`="s11")) %>%
            select(-sector)

IOlong <- gather(IOwide,key="colnames",value="vals",-county,-rownames,factor_key = TRUE) %>%
          mutate(matrix="IO",rowtypes="sector",coltypes="sector") %>%
          group_by(county,matrix)

IO.df  <- collapse_to_matrices(IOlong,matnames="matrix",matvals="vals") %>%
   mutate(g = (rowsums_byname(vals)))
```
,
          A = matrixproduct_byname(vals,hatinv_byname(g)))
```
,
          L = solve(diag(nrow(A))-A),
          Bona_cent=colsums_byname(L))  %>%
    select(-matrix, -vals)


```

## Read in the Simulation Results and Create Variables for Analysis
```{r IO}
filename="AggResults01pct.csv"
fileNamewithPath <- file.path(data,results,filename)

shock01 <- as_tibble(read_csv(fileNamewithPath)) %>%
            mutate(sector=dplyr::recode(sector,`0`="Total",`1`="s01",`20`="s02",`41`="s03",
                                        `52`="s04",`65`="s05",
                                        `395`="s06",`396`="s07",`408`="s08",
                                        `417`="s09",`472`="s10",`520`="s11")) %>%
            select(-description)

```

```{r}


simoutput <- shock01 %>% mutate(description=NULL) %>%
                         mutate(indirectdrop=100*(indirect-direct)/direct) %>%
                         mutate(induceddrop=100*(induced-direct)/direct) %>%
                         mutate(totaldrop=100*(total-direct)/direct) 

simoutput
```

## Explore Bivariate Relationships

```{r, results='asis'}

gf_point(indirectdrop ~ Bona_cent,data=simoutput %>% filter(sector==0), color="blue", size = ~ numind,
         title = "Centrality in Production Networks and Propogation of Sectoral Shock",
         subtitle = "(Using Bonacich Centrality)",
         caption = "Source: IMPLAN Michigan County Data, 2014") %>%
  
gf_lm(indirectdrop ~ Bona_cent,data=simoutput %>% filter(sector==0) )
lm(indirectdrop ~ Bona_cent,data=simoutput %>% filter(sector==0) ) %>% stargazer(type="html")

```

```{r, results='asis'}

gf_point(indirectdrop ~ B_mean,data=simoutput %>% filter(sector==0), color="blue", size = ~ numind,
         title = "Centrality in Production Networks and Propogation of Sectoral Shock",
         subtitle = "(Using Bonacich Centrality)",
         caption = "Source: IMPLAN Michigan County Data, 2014") %>%
  
gf_lm(indirectdrop ~ B_mean,data=simoutput %>% filter(sector==0) )
lm(indirectdrop ~ B_mean,data=simoutput %>% filter(sector==0) ) %>% stargazer(type="html")

```
